<!doctype html>

<html lang="en">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>PCM5102A Stream Player</title>

  <style>
.led { display:inline-block; width:10px; height:10px; border-radius:50%; background:#666; margin-left:6px; vertical-align:middle; }
    button.micro { padding:2px 6px; font-size:12px; margin-left:6px; }

    :root { --bg:#0b0f14; --card:#121822; --acc:#2eaadc; --text:#e9f1f5; --muted:#9ab3c0; --success:#28a745; }

    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg); color:var(--text); }

    .wrap { max-width:900px; margin:6vh auto; padding:24px; background:var(--card); border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.25); }

    h1 { margin:0 0 8px; font-size:26px; color:var(--acc); }

    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }

    .user-info { font-size:14px; color:var(--muted); }

    .user-info a { color:var(--acc); text-decoration:none; }

    .user-info a:hover { text-decoration:underline; }

    h2 { margin:24px 0 12px; font-size:20px; color:var(--acc); }

    label { display:block; font-size:14px; color:var(--muted); margin:10px 0 6px; }

    input, select { width:100%; padding:12px 14px; border-radius:10px; border:1px solid #213040; background:#0e141c; color:var(--text); outline:none; box-sizing:border-box; font-size:15px; }

    input:focus, select:focus { border-color:var(--acc); }

    .row { display:flex; gap:12px; align-items:center; margin-top:16px; flex-wrap:wrap; }

    button { appearance:none; border:0; padding:12px 18px; border-radius:10px; background:var(--acc); color:#022; font-weight:600; cursor:pointer; transition:all 0.2s; font-size:15px; }

    button:hover { opacity:0.9; transform:translateY(-1px); }

    button.secondary { background:#223244; color:var(--text); }

    button:disabled { opacity:0.5; cursor:not-allowed; }

    .status { margin-top:18px; font-size:14px; padding:12px; background:#0e141c; border-radius:8px; color:var(--muted); }

    .status.success { color:var(--success); }

    .status.error { color:#dc3545; }

    .section { margin:24px 0; padding:20px; background:#0e141c; border-radius:12px; border:1px solid #213040; }

    .slider-container { margin:16px 0; }

    .slider { width:100%; height:6px; border-radius:3px; background:#213040; outline:none; -webkit-appearance:none; cursor:pointer; }

    .slider::-webkit-slider-thumb { -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%; background:var(--acc); cursor:pointer; }

    .slider::-moz-range-thumb { width:18px; height:18px; border-radius:50%; background:var(--acc); cursor:pointer; border:none; }


    .controls { display:flex; gap:12px; align-items:center; justify-content:center; margin:20px 0; }

    .play-btn { font-size:24px; padding:16px 32px; background:var(--success); }

    .info { background:#1a2532; padding:12px; border-radius:8px; font-size:13px; color:var(--muted); margin:12px 0; }

  </style>

</head>

<body>

  <div class="wrap">

    <div class="header">

      <h1>üéß PCM5102A Stream Player</h1>

      <div class="user-info">

        Logged in as: <strong>{{ session.username if session else 'admin' }}</strong> | 

        <a href="/logout">Logout</a>

      </div>

    </div>



    <div class="section">
      <h2>Audio Player</h2>
      <label>Link 1 <span id="led1" class="led"></span> <button class="micro" title="Start" onclick="startBg(1)">‚ñ∂</button> <button class="micro" title="Stop" onclick="stopBg(1)">‚ñ†</button></label>
      <input id="url1" placeholder="example.com:8000/;stream"  value="{{ config.get('stream_url1','') }}" />
      <label>Link 2 (fallback) <span id="led2" class="led"></span> <button class="micro" title="Start" onclick="startBg(2)">‚ñ∂</button> <button class="micro" title="Stop" onclick="stopBg(2)">‚ñ†</button></label>
      <input id="url2" placeholder="backup:8000/;stream"  value="{{ config.get('stream_url2','') }}" />
      <label>Buffer (seconds)</label>
      <input id="buffer" type="number" min="1" max="60" value="12" />
      <div class="controls">
        <button id="playBtn" class="play-btn" onclick="startDual()">‚ñ∂ Play All</button>
        <button class="secondary" onclick="toggleLinks()">‚áÑ Toggle Links</button>
        <button id="stopBtn" class="secondary" onclick="stopPlay()">‚èπ Stop All</button>
      </div>
      <div class="status" id="playerStatus">Ready to play</div>
    </div>

      <div class="status" id="playerStatus">Ready to play</div>

    </div>



    <div class="section">
      <h2>Meters</h2>
      <div class="info">Simple peak meters: Link1, Link2 (sampled), Output (live).</div>
      <div id="meters" style="display:flex; gap:12px; flex-wrap:wrap;">
        <canvas id="m1" width="120" height="16" style="background:#0e141c;border:1px solid #213040;border-radius:4px"></canvas>
        <canvas id="m2" width="120" height="16" style="background:#0e141c;border:1px solid #213040;border-radius:4px"></canvas>
        <canvas id="mOut" width="120" height="16" style="background:#0e141c;border:1px solid #213040;border-radius:4px"></canvas>
      </div>
    </div>

    <div class="section">




      <div class="row">






      </div>

      <div class="row" style="justify-content:flex-start;margin-top:20px;">


      </div>


    </div>



    

  </div>



  
<script>
  const st = m => document.getElementById('playerStatus') ? (document.getElementById('playerStatus').textContent=m) : null;
  const g = id => document.getElementById(id);
  function norm(db){ return Math.max(0, Math.min(1, (db+60)/60)); }
  function drawBar(cv, nl, nr){
    const ctx = cv.getContext('2d');
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.fillStyle='#2eaadc';
    ctx.fillRect(0,0, Math.floor(nl*cv.width), cv.height/2-1);
    ctx.fillRect(0,cv.height/2+1, Math.floor(nr*cv.width), cv.height/2-2);
  }
  async function startPlay(){
    const url1 = (g('url1').value||'').trim();
    const buffer = parseInt(g('buffer').value||'12',10);
    const body = { url: url1, bufferSecs: buffer };
    st('Starting...');
    try{
      await fetch('/api/login',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:'admin',password:'admin123'})});
      const r = await fetch('/api/start',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const j = await r.json();
      st(j.success ? 'Playing' : ('Failed'+(j.message?': '+j.message:'')));
    }catch(e){ st('Error: '+e); }
  }
  async function switchToLink2(){
    const url2 = (g('url2').value||'').trim();
    st('Switching...');
    try{
      const r = await fetch('/api/switch',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({url2})});
      const j = await r.json();
      st(j.success ? 'Switched to Link 2' : ('Failed'+(j.message?': '+j.message:'')));
    }catch(e){ st('Error: '+e); }
  }
  async function stopPlay(){ st('Stopping...'); await fetch('/api/stop',{method:'POST'}); st('Stopped'); }
  async function pollMeters(){
    try{
      const url1 = (g('url1')?g('url1').value:'').trim();
      const url2 = (g('url2')?g('url2').value:'').trim();
      // Link1/2 sample meters
      if(url1){ const r1 = await fetch('/api/levels?url='+encodeURIComponent(url1)); const j1 = await r1.json(); drawBar(g('m1'), norm(j1.L_db||-60), norm(j1.R_db||-60)); }
      if(url2){ const r2 = await fetch('/api/levels?url='+encodeURIComponent(url2)); const j2 = await r2.json(); drawBar(g('m2'), norm(j2.L_db||-60), norm(j2.R_db||-60)); }
      // Output meter from levels.json via API
      const ro = await fetch('/api/output_levels'); const jo = await ro.json();
      const ll = jo.levels || {}; drawBar(g('mOut'), norm((ll.L_db??-60)), norm((ll.R_db??-60)));
    }catch(e){ /* ignore */ }
    setTimeout(pollMeters, 300);
  }
<script>
async function startDual(){ const s=document.getElementById("playerStatus"); try{const r=await fetch("/api/start_dual",{method:'POST'}); const j=await r.json(); if(s){ s.textContent = j.success? "Playing L1 (dual started)" : ("Failed: "+(j.message||"start_dual")); }}catch(e){ if(s){ s.textContent="Error starting"; } } }
</script>
<script>
async function pollHealth(){try{const r=await fetch("/api/link_health"); const j=await r.json(); const l1=document.getElementById("led1"); const l2=document.getElementById("led2"); if(l1){l1.style.background = j.l1?"#28a745":"#dc3545";} if(l2){l2.style.background = j.l2?"#28a745":"#dc3545";} }catch(e){} setTimeout(pollHealth, 3000);} window.addEventListener("load", pollHealth);
async function startBg(i){ await fetch("/api/link/"+i+"/start_bg",{method:"POST"}); }
async function stopBg(i){ await fetch("/api/link/"+i+"/stop_bg",{method:"POST"}); }
</script>
  window.addEventListener('load', pollMeters);
</script>
<script>
async function toggleLinks(){try{const r=await fetch("/api/toggle",{method:'POST'});const j=await r.json();const s=document.getElementById("playerStatus");if(j.success){if(s){s.textContent="Switched to "+(j.active_idx===1?"Link 1":"Link 2");}}else{if(s){s.textContent="Failed: "+(j.message||"toggle");}}}catch(e){const s=document.getElementById("playerStatus"); if(s){s.textContent="Error toggling";}}}
</script>
<script>
function postJSON(u,b){return fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});}
function onSaveLink(e){const id=e.target.id;const k=id==='url1'?'stream_url1':(id==='url2'?'stream_url2':null);if(!k)return;const v=(e.target.value||'').trim();postJSON('/api/config',{[k]:v}).catch(()=>{});}
window.addEventListener('DOMContentLoaded',()=>{['url1','url2'].forEach(id=>{const el=document.getElementById(id);if(el){['change','blur'].forEach(ev=>el.addEventListener(ev,onSaveLink));}});});
</script>


</body>

</html>
